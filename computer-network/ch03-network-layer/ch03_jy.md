
## **Ch 3. 네트워크 계층**
- 네트워크 간의 통신이 가능하게 하는 계층
### **01. IP**

#### **네트워크 계층**
- 물리 계층과 데이터링크 계층 > LAN에 국한된 통신

- LAN을 넘기 위한 계층

- 네트워크 간 통신이 가능한 계층 > 라우팅
    
    - 라우팅 : 패킷을 목적지까지 최적의 경로로 찾아가는 과정
    
    - 라우터 : 라우팅을 가능하게 하는 장비

- 단편화가 이루어지는 계층

    - 단편화 : 패킷으로 쪼개는 과정 

    - IP 프로토콜을 이용해서 단편화

##### **데이터링크 계층의 MAC 주소가 있는데 왜 IP?**
>- 도달 경로를 파악하기 어려움(라우팅 어려움)
>
>    - 데이터를 보내기 위해서는 제대로 된 주소가 필요로 하다
>
>    - 같은 LAN에서도 MAC주소 만으로 통신이 가능하지만 기본적으로 IP주소가 먼저 활용된다


- 임의의 네트워크에 속한 호스트의 MAC 주소를 기억하기 어려움

>- MAC주소
>
>    - MAC주소 = 물리주소(주민번호) (변경불가능) 
>
>    - NIC를 제작할때 고유할당
>
>- IP주소
>
>    - IP주소는 논리주소 (거주지) (변경가능)
>
>    - 직접 할당
>    
>    - 자동 할당(DHCP)

#### **IP의 두가지 주요 기능**
- IP 주소 지정

- 단편화

- [IP공식문서](https://datatracker.ietf.org/doc/html/rfc791)

>#### **단편화**
>- 패킷의 크기를 MTU(Maximum Transmission Unit) 이하로 유지
>
>- MTU 크기 이하로 단편화된 패킷들은 목적지에서 재조합

#### **IPv4 헤더**
- 송신지, 목적지 IP주소

>- 식별자, 플래그, 단편화
>    - 단편화에서 주로 사용되는 헤더 3가지
>
>    - 식별자 : 패킷에 할당된 번호 (재조합 시 사용)
>
>    - 플래그 : 부가 정보 (미사용, Don't Fragment, More Fragment 비트)
>
>    - 단편화 오프셋 : 단편화되기 전 데이터가 첫번째 패킷으로부터 얼마나 떨어져 패킷인가의 정보

- TTL, 프로토콜
    - TTL(Time To Live) : 패킷의 수명, 라우터를 거칠 때마다 1감소
        + 무한 순환이 생길수 있어서 필요로 함
    - 프로토콜 : 상위 계층의 프로토콜 (e.g. TCP==6, UDP==17)

#### **IPv4 주소**

- 4바이트 (32비트)로 표현 가능

- 한 옥텟은 0~255 범위의 네 개의 십진수로 표기

- 이론적으로 할당 가능한 IPv4 주소 개수 == 2^32개

- IP 주소 부족 문제

- 아직 고갈되지 않았음

#### **IPv6 주소**
- 16바이트 (128비트)로 표현 가능

- 이론적으로 할당 가능한 IPv6주소 개수 == 2^128개

- 의외로 헤더가 더 단순하다.

<hr/>

### **02.ARP**
- IP 주소를 통해 MAC 주소를 알아내기 위한 프로토콜

- **동일 네트워크 내의** 호스트의 MAC주소를 알아내기 위한 프로토콜

#### **ARP 동작 과정**
1. ARP 요청

2. ARP 응답

3. ARP 테이블(ARP캐시) 갱신

##### **1. ARP 요청 (브로드캐스트 메세지)**
- 특정 IP주소를 가진 호스트의 MAC 주소를 알아내기 위해 보내는 브로드캐스트 메세지

- 해당 호스트의 MAC 주소를 모르기 때문에 브로드캐스트 메세지로 전송

##### **2. ARP 응답**
- ARP 요청 메세지에 대한 응답. 자신의 MAC 주소 포함

##### **3. ARP 테이블 갱신**
- ARP 테이블(ARP캐시): MAC 주소와 IP 주소가 매핑된 표 형태의 데이터

- 일정 시간이 지나면 삭제

- ARP테이블에 추가된 호스트는 브로드캐스트로 ARP 요청을 보낼 필요 없음(트래픽 증가를 막기위해)

##### **다른 네트워크에 속한 호스트의 MAC 주소 알아내기**
1. 라우터의 mac주소를 1차적으로 알아냄

2. 다른 라우터의 mac주소를 알아내서 연결된 호스트의 mac주소를 알아냄

- 라우팅 프로토콜, arp 등 여러가지가 필요

<hr/>

### **03.ICMP**

#### **IP프로토콜의 한계**
1. 비신뢰성
    - 패킷이 목적지까지 제대로 전송한다는 보장이 없는 특성

    - 최선형 전달(best-effort delivery)

    - 신뢰성 프로토콜, 연결형 프로토콜을 제공하는 계층은 전송 계층(TCP)
2. 비연결형
    - 호스트 간의 사전 연결 수립이 없는 특성

#### ICMP
- IP의 비신뢰성과 비연결형 특성을 보완하기 위한 네트워크 계층 프로토콜

- IP 패킷의 전송 과정에 대한 피트백 메세지 제공
    
    - 오류보고

    - 네트워크 진단 정보

- $traceroute [url] url 호스트에 도달하기 위한 전체 경로 출력

- IP의 한계를 보완할 뿐 완전히 해결하는 것은 아니다.

- 근본적인 해결은 전송 계층에서 이루어짐

[ICMP공식문서](https://www.rfc-editor.org/rfc/rfc792)

<hr/>

### **04.IP 주소**

- IP 주소의 구성
    - 네트워크 주소, 호스트 주소(**유동적**)

- MAC주소의 구성
    - 제조사 번호, 일련번호 (24/24비트 고정)

##### **클래스풀 주소체계**
- 정해져 있는 클래스(크기)에 맞게 호스트 IP 할당

##### **클래스리스 주소체계**
- 클래스풀 주소 체계보다 더 정교히 네트워크를 나누는 방법

- 오늘날 주로 사용하는 방식

- 네트워크와 호스트를 구분하기 위해 **서브넷 마스크** 이용

    - 서브넷 마스크
        + IP주소 상에서 네트워크 주소는 1, 호스트 주소는 0으로 이루어진 비트열

        + 클래스 A : 255.0.0.0

        + 클래스 B : 255.255.0.0

        + 클래스 C : 255.255.255.0

- 서브넷 마스크와 IP 주소의 비트 AND연산 > 네트워크 주소 (둘다 1일때 1)

##### **CIDR 표기**
- 서브넷 마스크 상의 1의 개수를 IP주소/숫자로 표기

- 192.168.100.103/**30**

- '''네트워크 주소를 빼는 이유가 뭐지?'''

<hr/>

### **06.IP주소의 분류**

#### **공인IP 주소와 사설 IP 주소**
- 공인 IP 주소 : 인터넷 사용할 때 사용하는 고유한 주소

- 사설 IP 주소 : 사설 네트워크 내에서 사용하는 고유하지 않은 주소
    
    - 사설 IP 주소 대역
        + 10.0.0.0/8

        + 172.16.0.0/12

        + 192.16.0.0/16

#### **NAT**
- 공인 IP 주소와 사설 IP 주소 간의 변환 기능
        
    - 하나의 공인 IP 주소를 여러 사설 IP 주소가 공유 가능

    - IP 주소 부족 문제 해결

##### **정적 IP 주소와 동적 IP 주소**
- IP 주소의 할당 방법 : 정적 할당과 동적 할당

- 정적 IP 주소 : 정적 할당된 IP 주소 (고정)

- 동적 IP 주소 : 동적 할당된 IP 주소 (유동적)

#### **DHCP**

- 동적 IP 주소를 할당하기 위한 프로토콜

- DHCP 서버에 의해 동적으로 IP 주소 할당 (==IP 주소 임대)

- 정해진 임대 시간이 끝날 경우 임대 갱신 (자동 수행, 수동 수행)

<hr/>

### **07.라우팅**

#### **라우터**
- LAN에서 외부로 나가기 위한 최초 라우터 = **Default gateway**
    "다음 라우터는 공인IP인지?"

- 라우팅 : 피킷이 이동할 최적 경로 설정, 해당 경로로 패킷 이동

- 라우팅 피로토콜 : 라우팅을 수행하는 방법

- 홉 : 라우터와 라우터 간의 패킷 이동 과정

- 홉 바이 홉 라우팅

#### **라우팅 테이블**

- 특정 목적지까지 도달하기 위한 정보를 명시하는 표와 같은 정보

- 대표적인 정보 : 목적지 주소, 서브넷 마스크, 게이트웨이, 인터페이스, 메트릭(비용)

- 롱기스트 프리픽스 매치
    - 여러 라우팅 테이블 항목과 일치할 경우 가장 길게 일치하는 항목 선택 후 패킷 전송

- 디폴트 라우트
    - 합치되는 경로가 없을 경우 기본으로 내보낼 경로

- 라우팅 테이블
    - $route -v
    - $netstat -rn

- 만들어지는 과정
    - 정적 라우팅 : 수동으로 라우팅 테이블 항목 채워넣기
        - 중간 라우터에 문제가 생길때 패킷이 도달하지 않음

    - 동적 라우팅 : 자동으로 라우팅 테이블 항목 채워넣기 (라우팅 프로토콜)
        - 경로 우회 가능

#### **라우팅 프로토콜**
- AS 내부 라우팅 프로토콜(IGP) : RIP(거리 백터 활용), OSPF(링크 상태 활용)

- AS 외부 라우팅 프로토콜(EGP) : BGP

- AS == 동일한 라우팅 정책으로 운영되는 라우터들의 집단 네트워크
